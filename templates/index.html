<!-- templates/index.html -->

<!DOCTYPE html>
<html>
<head>
    <title>Custom QR Code Reader</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 50px; background-color: #f2f2f2; }
        .container { max-width: 600px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); }
        h1 { text-align: center; }
        form { margin-bottom: 30px; }
        input[type="file"], input[type="text"] { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; }
        button { padding: 10px 20px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background-color: #45a049; }
        #result { margin-top: 20px; padding: 10px; background-color: #e7f3fe; border-left: 6px solid #2196F3; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/14.2.1/math.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>Custom QR Code Reader</h1>

        <h2>Decode QR Code</h2>
        <form id="decode-form" enctype="multipart/form-data">
            <input type="file" name="qr_image" accept="image/png, image/jpeg" required>
            <button type="submit">Decode QR Code</button>
        </form>

        <h2>Encode QR Code</h2>
        <form id="encode-form" enctype="multipart/form-data">
            <input type="text" name="data" placeholder="Enter text to encode" required>
            <button type="submit">Encode to QR Code</button>
        </form>

        <div id="decode-result"></div>
        <div id="encode-result"></div>
    </div>

    <script>
        // Handle Decode Form Submission
        document.getElementById('decode-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const response = await fetch('/decode', {
                method: 'POST',
                body: formData
            });
            const result = await response.json();
            const resultDiv = document.getElementById('decode-result');
            if (response.ok) {
                const processedResult = processDecodedStringWithMathJS(result.decoded_string);
                resultDiv.innerHTML = `<div id="result"><h3>Decoded String:</h3><pre>${processedResult}</pre></div>`;
            } else {
                resultDiv.innerHTML = `<div id="result"><h3>Error:</h3><p>${result.error}</p></div>`;
            }
        });

        function solveLinearEquationWithMathJS(eqString) {
            try {
                const parts = eqString.split('=');
                if (parts.length !== 2) return "[Client-side Error: Invalid equation format]";
                const lhs = parts[0].trim();
                const rhs = parts[1].trim();
                const exprNode = math.parse(`${lhs} - (${rhs})`);
                const simplifiedExpr = math.simplify(exprNode);

                // Let f(x) be the simplified expression node (simplifiedExpr). We solve f(x) = 0.
                // b_val = f(0)
                // a_plus_b_val = f(1)
                // a = a_plus_b_val - b_val
                // x = -b_val / a

                let b_val, a_plus_b_val;
                try {
                    b_val = simplifiedExpr.evaluate({x: 0});
                    a_plus_b_val = simplifiedExpr.evaluate({x: 1});
                } catch (e) {
                    // This can happen if 'x' is not in the simplified expression (e.g. "3=5" -> "-2")
                    if (simplifiedExpr.isConstantNode) { // e.g. simplified to a number
                        return Math.abs(simplifiedExpr.value) < 1e-9 ? "[Client-side solution: Infinite solutions (identity)]" : "[Client-side solution: No solution (contradiction)]";
                    }
                    return "[Client-side Error: Equation not in a solvable linear form (e.g., no 'x')]";
                }


                if (typeof b_val !== 'number' || typeof a_plus_b_val !== 'number' ) {
                     return "[Client-side Error: Could not evaluate coefficients to numbers]";
                }

                const a_val = a_plus_b_val - b_val;

                if (Math.abs(a_val) < 1e-9) { // Coefficient 'a' is close to zero
                    return Math.abs(b_val) < 1e-9 ? "[Client-side solution: Infinite solutions (identity)]" : "[Client-side solution: No solution (contradiction)]";
                } else {
                    const x_solution = -b_val / a_val;
                    return `[Client-side solution: x = ${math.format(x_solution, {precision: 14})}]`;
                }
            } catch (err) {
                console.error("Error solving linear equation with math.js:", eqString, err);
                return "[Client-side Error: " + err.message + "]";
            }
        }

        function solvePowerEquationWithMathJS(eqString) {
            try {
                const parts = eqString.split('=');
                if (parts.length !== 2) return "[Client-side Error: Invalid equation format]";

                const exprNode = math.parse(`${parts[0].trim()} - (${parts[1].trim()})`);
                const simplified = math.simplify(exprNode); // e.g. x^2 - 9 or 2*x^3 - 54

                // Attempt for x^n - C = 0 form
                if (simplified.isOperatorNode && simplified.op === '-' && simplified.args.length === 2 &&
                    simplified.args[0].isOperatorNode && simplified.args[0].op === '^' &&
                    simplified.args[0].args[0].isSymbolNode && simplified.args[0].args[0].name === 'x' &&
                    simplified.args[1].isConstantNode) {

                    const n = simplified.args[0].args[1].value; // exponent
                    const C = simplified.args[1].value; // constant C (so equation is x^n = C)

                    if (C < 0 && n % 2 === 0) return `[Client-side solution: No real solution for x^${n} = ${C}]`;

                    const solutions = [];
                    const principalRoot = math.evaluate(`${C}^(1/${n})`); // Use math.evaluate for roots
                    solutions.push(principalRoot);

                    if (n % 2 === 0 && Math.abs(C) > 1e-9 && Math.abs(principalRoot) > 1e-9) {
                        solutions.push(-principalRoot);
                    }
                    return `[Client-side solution: x = ${solutions.map(s => math.format(s, {precision: 14})).join(' or x = ')}]`;
                }
                // Attempt for a*x^n - C = 0 form
                else if (simplified.isOperatorNode && simplified.op === '-' && simplified.args.length === 2 &&
                         simplified.args[0].isOperatorNode && simplified.args[0].op === '*' && // a*x^n part
                         simplified.args[0].args[1].isOperatorNode && simplified.args[0].args[1].op === '^' && // x^n part
                         simplified.args[0].args[1].args[0].isSymbolNode && simplified.args[0].args[1].args[0].name === 'x' && // x
                         simplified.args[0].args[0].isConstantNode && // a
                         simplified.args[1].isConstantNode) { // C

                    const a = simplified.args[0].args[0].value;
                    const n = simplified.args[0].args[1].args[1].value;
                    const C = simplified.args[1].value; // Constant C (so equation is a*x^n = C)

                    if (a === 0) return "[Client-side Error: Coefficient 'a' is zero]";
                    const valForPower = C / a;

                    if (valForPower < 0 && n % 2 === 0) return `[Client-side solution: No real solution for ${a}*x^${n} = ${C}]`;

                    const solutions = [];
                    const principalRoot = math.evaluate(`${valForPower}^(1/${n})`);
                    solutions.push(principalRoot);

                    if (n % 2 === 0 && Math.abs(valForPower) > 1e-9 && Math.abs(principalRoot) > 1e-9) {
                        solutions.push(-principalRoot);
                    }
                    return `[Client-side solution: x = ${solutions.map(s => math.format(s, {precision: 14})).join(' or x = ')}]`;
                }


                return "[Client-side: Solver for this power equation form not implemented yet]";
            } catch (err) {
                console.error("Error solving power equation with math.js:", eqString, err);
                return "[Client-side Error: " + err.message + "]";
            }
        }

        function processDecodedStringWithMathJS(decodedString) {
            if (typeof math === 'undefined' || !decodedString || typeof decodedString !== 'string') {
                console.warn("Math.js not loaded or invalid input to processDecodedStringWithMathJS");
                return decodedString;
            }

            const linearRegex = /<linear>(.*?)<\/linear>/g;
            const powerRegex = /<power>(.*?)<\/power>/g;
            let resultString = decodedString;

            resultString = resultString.replace(linearRegex, (match, eqContent) => {
                const solution = solveLinearEquationWithMathJS(eqContent);
                return `${match} ${solution}`;
            });

            resultString = resultString.replace(powerRegex, (match, eqContent) => {
                const solution = solvePowerEquationWithMathJS(eqContent);
                return `${match} ${solution}`;
            });

            return resultString;
        }

        // Handle Encode Form Submission
        document.getElementById('encode-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const response = await fetch('/encode', {
                method: 'POST',
                body: formData
            });
            if (response.ok) {
                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                const resultDiv = document.getElementById('encode-result');
                resultDiv.innerHTML = `<div id="result"><h3>Encoded QR Code:</h3><a href="${url}" download="encoded_qr.png">Download QR Code</a><br><img src="${url}" alt="Encoded QR Code"></div>`;
            } else {
                const result = await response.json();
                const resultDiv = document.getElementById('encode-result');
                resultDiv.innerHTML = `<div id="result"><h3>Error:</h3><p>${result.error}</p></div>`;
            }
        });
    </script>
</body>
</html>
